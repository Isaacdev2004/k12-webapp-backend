<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>R2 Multipart Upload Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      input, button { padding: .5rem; margin: .25rem 0; }
      progress { width: 100%; height: 16px; }
      .row { margin: .5rem 0; }
    </style>
  </head>
  <body>
    <h1>R2 Multipart Upload Test</h1>
    <div class="row">
      <input type="file" id="file" />
    </div>
    <div class="row">
      <label>Key:</label>
  <input id="key" placeholder="uploads/myfile.bin" value="" />
    </div>
    <div class="row">
      <button id="start">Start Upload</button>
      <button id="abort" disabled>Abort</button>
    </div>
    <progress id="prog" value="0" max="100"></progress>
    <pre id="log"></pre>
    <script>
      const logEl = document.getElementById('log');
      const prog = document.getElementById('prog');
  let uploadId = null;
  let parts = [];
  let aborted = false;
      document.getElementById('file').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const safe = f.name.replace(/[^a-zA-Z0-9._-]+/g, '_');
        document.getElementById('key').value = 'videos/' + safe;
      });

      function log(msg) { logEl.textContent += msg + "\n"; }

      async function postJson(url, body) {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify(body), credentials: 'include' });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
      async function getJson(url) {
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      async function start() {
        aborted = false; parts = []; prog.value = 0;
        const file = document.getElementById('file').files[0];
        const key = document.getElementById('key').value;
        if (!file) { alert('Choose a file'); return; }
        document.getElementById('start').disabled = true;
        document.getElementById('abort').disabled = false;
        try {
          // 1) initiate
          const init = await postJson('/api/uploads/multipart/initiate/', { key, contentType: file.type || 'application/octet-stream' });
          uploadId = init.uploadId;
          log('Initiated ' + uploadId);

          const chunkSize = 25 * 1024 * 1024; // 25MB
          const totalParts = Math.ceil(file.size / chunkSize);

          for (let partNumber = 1; partNumber <= totalParts; partNumber++) {
            if (aborted) throw new Error('aborted');
            const start = (partNumber - 1) * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const blob = file.slice(start, end);

            // 2) sign url for part
            const q = new URLSearchParams({ key, uploadId, partNumber });
            const { url } = await getJson('/api/uploads/multipart/sign-part/?' + q.toString());

            // 3) PUT part to R2
            const put = await fetch(url, { method: 'PUT', body: blob });
            if (!put.ok) throw new Error('PUT part failed ' + partNumber);
            const eTag = put.headers.get('ETag') || put.headers.get('etag');
            if (eTag) {
              parts.push({ ETag: eTag.replaceAll('"',''), PartNumber: partNumber });
            } else {
              // Allow server to list parts if ETag isn't exposed via CORS
              parts.push({ ETag: null, PartNumber: partNumber });
            }
            prog.value = Math.round((partNumber / totalParts) * 100);
            log('Uploaded part ' + partNumber + '/' + totalParts);
          }

          // 4) complete
          const done = await postJson('/api/uploads/multipart/complete/', { key, uploadId, parts });
          log('Completed: ' + JSON.stringify(done, null, 2));
          if (done && done.location) {
            log('URL: ' + done.location);
          }
        } catch (e) {
          log('Error: ' + e.message);
          if (uploadId) {
            try { await postJson('/api/uploads/multipart/abort/', { key, uploadId }); log('Aborted'); } catch {}
          }
        } finally {
          document.getElementById('start').disabled = false;
          document.getElementById('abort').disabled = true;
          uploadId = null;
        }
      }
      document.getElementById('start').addEventListener('click', start);
      document.getElementById('abort').addEventListener('click', () => { aborted = true; });
    </script>
  </body>
</html>
